name: Discord Notifications

on:
  push:
    branches: [ main ]

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR details
        id: pr
        run: |
          # Extract PR number from merge commit message
          PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -o '#[0-9]\+' | head -1 | sed 's/#//')
          if [ ! -z "$PR_NUMBER" ]; then
            # Get PR details using GitHub API
            PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title // empty')
            PR_BODY=$(echo "$PR_DATA" | jq -r '.body // empty')
            echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
            echo "pr_body<<EOF" >> $GITHUB_OUTPUT
            echo "$PR_BODY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Martian Moments Update
        uses: discord-actions/message@v2
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            ðŸš€ **Martian Moments Update**
            
            **${{ steps.pr.outputs.pr_title || github.event.head_commit.message }}**
            
            ${{ steps.pr.outputs.pr_body || 'No description provided.' }}
            
            ðŸ”— **[View Changes](${{ github.event.head_commit.url }})**
